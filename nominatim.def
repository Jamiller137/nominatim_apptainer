Bootstrap: docker
From: ubuntu:24.04

%arguments
  NOMINATIM_VERSION=5.1.0

%files
  # postgres configuration files:
  conf.d/postgres-import.conf /etc/postgresql/16/main/conf.d/postgres-import.conf.disabled
  conf.d/postgres-tuning.conf /etc/postgresql/16/main/conf.d/
  conf.d/env /nominatim/.env

  # Open Street Map (OSM) data:
  nominatim_project/iowa-latest.osm.pbf /app/data/iowa-latest.osm.pbf

  # Additional Metadata:
  nominatim_project/secondary_importance.sql.gz /app/data/secondary_importance.sql.gz
  nominatim_project/us_postcodes.csv.gz /app/data/us_postcodes.csv.gz
  nominatim_project/wikimedia-importance.csv.gz /app/data/wikimedia-importance.csv.gz
  nominatim_project/tiger-nominatim-preprocessed-latest.csv.tar.gz /app/data/tiger-nominatim-preprocessed-latest.csv.tar.gz


%environment
  # when building the container this avoids having to enter locale imformation
  export DEBIAN_FRONTEND=noninteractive
  export LANG=C.UTF-8

  # nominatim env var
  export PROJECT_DIR=/nominatim
  export USER_AGENT=mediagis/nominatim-docker:{{ NOMINATIM_VERSION }}

%post
  export NOMINATIM_VERSION={{ NOMINATIM_VERSION }}
  export PGDATA=/app/postgresql/data
  export POSTGRES_RUN_DIR=/app/postgresql/run
  export PROJECT_DIR=/nominatim
  export PBF_PATH=/app/data/iowa-latest.osm.pbf
  export IMPORT_STYLE=full

  # working dir 
  mkdir -p /app 
  cd /app

  # apt caching
  rm -f /etc/apt/apt.conf.d/docker-clean
  echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache

  # no daemons: since no init system package post-install scripts may try to start a service that doesnt exist.
  echo '#!/bin/sh\nexit 101' > /usr/sbin/policy-rc.d
  chmod +x /usr/sbin/policy-rc.d

%runscript
  #!/bin/bash
  echo "Nominatim placeholder container ready."

%help
  A base for the container. Defines Ubuntu 24.04 as the base image. With postgres supporty.
