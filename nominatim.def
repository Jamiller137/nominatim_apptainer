Bootstrap: docker
From: ubuntu:24.04

%arguments
  NOMINATIM_VERSION=5.1.0

%files
  # postgres configuration files:
  conf.d/postgres-import.conf /etc/postgresql/16/main/conf.d/postgres-import.conf.disabled
  conf.d/postgres-tuning.conf /etc/postgresql/16/main/conf.d/
  conf.d/env /nominatim/.env

  # Open Street Map (OSM) data:
  nominatim_project/iowa-latest.osm.pbf /app/data/iowa-latest.osm.pbf

  # Additional Metadata:
  nominatim_project/secondary_importance.sql.gz /app/data/secondary_importance.sql.gz
  nominatim_project/us_postcodes.csv.gz /app/data/us_postcodes.csv.gz
  nominatim_project/wikimedia-importance.csv.gz /app/data/wikimedia-importance.csv.gz
  nominatim_project/tiger-nominatim-preprocessed-latest.csv.tar.gz /app/data/tiger-nominatim-preprocessed-latest.csv.tar.gz


%environment
  # when building the container this avoids having to enter locale imformation
  export DEBIAN_FRONTEND=noninteractive
  export LANG=C.UTF-8

  # nominatim env var
  export PROJECT_DIR=/nominatim
  export USER_AGENT=mediagis/nominatim-docker:{{ NOMINATIM_VERSION }}

%post
  export NOMINATIM_VERSION={{ NOMINATIM_VERSION }}
  export PGDATA=/app/postgresql/data
  export POSTGRES_RUN_DIR=/app/postgresql/run
  export PROJECT_DIR=/nominatim
  export PBF_PATH=/app/data/iowa-latest.osm.pbf
  export IMPORT_STYLE=full

  # working dir 
  mkdir -p /app 
  cd /app

  # apt caching
  rm -f /etc/apt/apt.conf.d/docker-clean
  echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache

  # no daemons: since no init system package post-install scripts may try to start a service that doesnt exist.
  echo '#!/bin/sh\nexit 101' > /usr/sbin/policy-rc.d
  chmod +x /usr/sbin/policy-rc.d

  # since apt install postgresql-16 would start the postgres service the above is needed.

  # Update/Install apt packages:
  apt-get -y update -qq
  apt-get -y install locales
  locale.gen en_US.UTF-8
  update-locale LANG=en_US.UTF-8

  apt-get -y install \
    -o APT::Install-Recommends="false" \
    -o APT::Install-Suggests="false" \
    build-essential \
    osm2pgsql \
    pkg-config \
    libicu-dev \
    python3-dev \
    python3-pandas \
    python3-pip \
    python3-icu \
    postgresql-postgis \
    postgresql-postgis-scripts \
    sqlite3 \
    libsqlite3-mod-spatialite \
    spatialite-bin \
    curl \
    tree \
    vim \
    wget \
    unzip \
    gdal-bin \
    python3-gdal \
    sudo

  # Install Python packages:
  pip install --break-system-packages \
    nominatim-db==$NOMINATIM_VERSSION \
    nominatim-api==$NOMINATIM_VERSION \
    osmium \
    'psycopg[binary]' \
    aiosqlite \


%runscript
  #!/bin/bash
  echo "Nominatim placeholder container ready."

%help
  A base for the container. Defines Ubuntu 24.04 as the base image. With postgres supporty.
